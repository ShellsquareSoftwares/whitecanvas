var designSurface=function(){function e(){$canvas=$(canvasIdentifier)[0],ungroupMenu=$(ungroupMenu),groupMenu=$(groupMenu)}var i,t,n,o=[],r=[],h=0,l=0,s=!1,a=!1,c="null",d=0,u=0,g=function(i){showGrid=i.showGrid||!0,readOnly=i.readOnlyMode||!1,canvasIdentifier=i.displayCanvas,ungroupMenu=i.ungroupMenu,groupMenu=i.groupMenu,border=i.cornerWidth||15,selectionColor=i.selectBoxColor||"rgba(0,191,255,0.5)",borderWidth=i.borderWidth||2,dragBoxColor=i.dragBoxColor||"#00000",gridLineGap=i.gridLineGap||17,gridLineColor=i.gridLineColor||"#dcdcdc",arcRadius=i.cornerCircleRadius||6,groupBoxColor=i.groupSelectionBoxColour||"rgba(0,191,255,0.5)",e(),f(),H(),p()},f=function(){var e=document.createElement("canvas");e.style.position="absolute",e.style.zIndex=1,e.height=$canvas.height,e.width=$canvas.width,document.body.appendChild(e);var i=document.createElement("canvas");i.style.position="absolute",i.style.zIndex=2,i.height=$canvas.height,i.width=$canvas.width,document.body.appendChild(i);var t=document.createElement("canvas");t.style.position="absolute",t.style.zIndex=-1,t.height=$canvas.height,t.width=$canvas.width,document.body.appendChild(t),$gridSurface=t,$selectionSurface=e,$dragSurface=i},p=function(){readOnly||($dragSurface.addEventListener("mousedown",function(){m(),h=0},!1),$dragSurface.addEventListener("mousemove",function(){Y(),h=1},!1),$dragSurface.addEventListener("mouseout",function(){S(),h=1},!1),$dragSurface.addEventListener("mouseup",function(){v()},!1),$dragSurface.addEventListener("contextmenu",function(){event.preventDefault()},!1))},v=function(){0===h&&1===event.which?X():3===event.which&&(l=0,L()),1===h&&1===event.which,S()},w=function(e,i,t,n,r){var h=$("<img src="+e+">"),l={};l.image=h,l.id="IMG"+d,l.positionX=i,l.positionY=t,l.width=n,l.height=r,l.childElements=null,l.parentElement=null,o.push(l),d++;var s=$canvas.getContext("2d");h.load(function(){s.drawImage(this,i,t,n,r)})},X=function(){var e=[],r=0;l=0;var h=$selectionSurface.getContext("2d");h.clearRect(0,0,$selectionSurface.width,$selectionSurface.height);var s=D($dragSurface,event);i=endX=s.x,t=endY=s.y;for(var a=o.length,c=0;a>c;c++)null===o[c].parentElement&&i<o[c].positionX+o[c].width&&i>o[c].positionX&&t<o[c].positionY+o[c].height&&t>o[c].positionY&&(n=c,e[0]=o[c],z(),r=1);0===r&&(e.length=0)},m=function(){var e=$selectionSurface.getContext("2d"),h=!1;groupMenu.hide(),ungroupMenu.hide(),event.preventDefault(),l=1;var a=D($dragSurface,event);if(i=a.x,t=a.y,s=!1,r.length>1)for(var d=r.length-1;d>-1;d--)if(i<r[d].positionX+r[d].width+8&&i>r[d].positionX-8&&t<r[d].positionY+r[d].height+8&&t>r[d].positionY-8){for(var u=0;u<o.length;u++)o[u].id===r[d].id&&(c=b(i,t),n=u);return s=!0,void(h=!0)}if(!h)for(var g=o.length-1;g>-1;g--)if(null===o[g].parentElement){if(i<o[g].positionX+o[g].width+8&&i>o[g].positionX-8&&t<o[g].positionY+o[g].height+8&&t>o[g].positionY-8)return n=g,s=!0,r.length=0,r[0]=o[g],c=b(i,t),e.clearRect(0,0,$selectionSurface.width,$selectionSurface.height),void z();e.clearRect(0,0,$selectionSurface.width,$selectionSurface.height),r.length=0}},Y=function(){if(event.preventDefault(),1==l)if(s&&"null"==c)P();else if(s&&"null"!==c){var e=D($dragSurface,event),i=e.x,t=e.y;y[c](i,t),I();var r=$selectionSurface.getContext("2d");r.clearRect(0,0,$selectionSurface.width,$selectionSurface.height),z()}else{$dragSurface.style.cursor="crosshair";var e=D($dragSurface,event);endX=e.x,endY=e.y,E(endX,endY)}else for(var e=D($dragSurface,event),h=e.x,a=e.y,d=o.length,u=d-1;u>-1;u--){if(h<o[u].positionX+o[u].width+border/2&&h>o[u].positionX-border/2&&a<o[u].positionY+o[u].height+border/2&&a>o[u].positionY-border/2)return n=u,void G(h,a);$dragSurface.style.cursor="default"}},S=function(){event.preventDefault();var e=$dragSurface.getContext("2d");$dragSurface.style.cursor="default",l=0,e.clearRect(0,0,$dragSurface.width,$dragSurface.height),s=!1},E=function(e,n){var h=0;r=[];var l=$dragSurface.getContext("2d"),s=$selectionSurface.getContext("2d"),c=e-i,d=n-t,u=0>c?c:0,g=0>d?d:0,f=Math.abs(c),p=Math.abs(d);l.clearRect(0,0,$dragSurface.width,$dragSurface.height),l.beginPath(),l.rect(i+u,t+g,f,p),l.strokeStyle=dragBoxColor,l.setLineDash([15,10]),l.stroke();for(var v=0;v<o.length;v++)if(null===o[v].parentElement){var w=o[v].positionX,X=o[v].positionY,m=o[v].positionX+o[v].width,Y=o[v].positionY+o[v].height;i+u+f>w&&m>i+u&&t+g+p>X&&Y>t+g&&(r[h]=o[v],h++,a=!0,s.clearRect(0,0,$selectionSurface.width,$selectionSurface.height),z())}},P=function(){var e=D($dragSurface,event);endX=e.x,endY=e.y;for(var n=endX-i,o=endY-t,h=0;h<r.length;h++){r[h].positionX+=n,r[h].positionY+=o,null!==r[h].childElements&&R(r[h].childElements,n,o);var l=$selectionSurface.getContext("2d");l.clearRect(0,0,$selectionSurface.width,$selectionSurface.height),z()}I(),i=endX,t=endY},R=function(e,i,t){for(var n=0;n<e.length;n++)null!==e[n].childElements?(e[n].positionX+=i,e[n].positionY+=t,R(e[n].childElements,i,t)):(e[n].positionX+=i,e[n].positionY+=t)},b=function(e,i){var t=o[n].positionX,r=o[n].positionY,h=o[n].positionX+o[n].width,l=o[n].positionY+o[n].height,s=e>t-border/2&&e<t+border/2,a=e<h+border/2&&e>h-border/2,c=i>r-border/2&&i<r+border/2,d=i<l+border/2&&i>l-border/2;return c&&s?"TL":c&&a?"TR":d&&s?"BL":d&&a?"BR":c?"T":a?"R":d?"B":s?"L":"null"},y={T:function(e,i){for(var t=o[n].positionY-i,h=t/o[n].height*100,l=0;l<r.length;l++)if(r[l].childElements){var s=r[l].positionY-r[l].height/100*h;M(r[l].childElements,e,s,"T",l)}for(var a=0;a<r.length;a++)r[a].positionY-=r[a].height/100*h,r[a].height+=r[a].height/100*h},B:function(e,i){for(var t=o[n].positionY+o[n].height-i,h=t/o[n].height*100,l=0;l<r.length;l++)if(r[l].childElements){var s=r[l].positionY+r[l].height-r[l].height/100*h;M(r[l].childElements,e,s,"B",l)}for(var a=0;a<r.length;a++)r[a].height-=r[a].height/100*h},L:function(e,i){for(var t=o[n].positionX-e,h=t/o[n].width*100,l=0;l<r.length;l++)if(r[l].childElements){var s=r[l].positionX-r[l].width/100*h;M(r[l].childElements,s,i,"L",l)}for(var a=0;a<r.length;a++)r[a].positionX-=r[a].width/100*h,r[a].width+=r[a].width/100*h},R:function(e,i){for(var t=o[n].positionX+o[n].width-e,h=t/o[n].width*100,l=0;l<r.length;l++)if(r[l].childElements){var s=r[l].positionX+r[l].width-r[l].width/100*h;M(r[l].childElements,s,i,"R",l)}for(var a=0;a<r.length;a++)r[a].width-=r[a].width/100*h},TR:function(e,i){for(var t=o[n].positionY-i,h=t/o[n].height*100,l=e-(o[n].positionX+o[n].width),s=l/o[n].width*100,a=0;a<r.length;a++)if(r[a].childElements){var c=r[a].positionX+r[a].width-r[a].width/100*-s,d=r[a].positionY-r[a].height/100*h;M(r[a].childElements,c,d,"TR",a)}for(var u=0;u<r.length;u++)r[u].positionY-=r[u].height/100*h,r[u].height+=r[u].height/100*h,r[u].width+=r[u].width/100*s},BR:function(e,i){for(var t=i-(o[n].positionY+o[n].height),h=t/o[n].height*100,l=e-(o[n].positionX+o[n].width),s=l/o[n].width*100,a=0;a<r.length;a++)if(r[a].childElements){var c=r[a].positionX+r[a].width-r[a].width/100*-s,d=r[a].positionY+r[a].height-r[a].height/100*-h;M(r[a].childElements,c,d,"BR",a)}for(var u=0;u<r.length;u++)r[u].height+=r[u].height/100*h,r[u].width+=r[u].width/100*s},BL:function(e,i){for(var t=i-(o[n].positionY+o[n].height),h=t/o[n].height*100,l=o[n].positionX-e,s=l/o[n].width*100,a=0;a<r.length;a++)if(r[a].childElements){var c=r[a].positionX-r[a].width/100*s,d=r[a].positionY+r[a].height-r[a].height/100*-h;M(r[a].childElements,c,d,"BL",a)}for(var u=0;u<r.length;u++)r[u].height+=r[u].height/100*h,r[u].positionX-=r[u].width/100*s,r[u].width+=r[u].width/100*s},TL:function(e,i){for(var t=o[n].positionX-e,h=t/o[n].width*100,l=o[n].positionY-i,s=l/o[n].height*100,a=0;a<r.length;a++)if(r[a].childElements){var c=r[a].positionX-r[a].width/100*h,d=r[a].positionY-r[a].height/100*s;M(r[a].childElements,c,d,"TL",a)}for(var u=0;u<r.length;u++)r[u].positionY-=r[u].height/100*s,r[u].height+=r[u].height/100*s,r[u].positionX-=r[u].width/100*h,r[u].width+=r[u].width/100*h}},M=function(e,i,t,n,o){for(var h=0;h<e.length;h++){if("L"===n){var l=r[o].positionX,s=r[o].width,a=l-i,c=a/s*100;effectivePX=l+s-e[h].positionX;var d=e[h].width/100*c,u=effectivePX/100*c;e[h].positionX-=u,e[h].width+=d,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("R"===n){var l=r[o].positionX,s=r[o].width,a=l+s-i,c=a/s*100;effectivePX=e[h].positionX-l;var d=e[h].width/100*c,u=effectivePX/100*c;e[h].width-=d,e[h].positionX-=u,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("B"===n){var g=r[o].positionY,f=r[o].height,p=g+f-t,v=p/f*100,w=e[h].positionY-g,X=e[h].height/100*v,m=w/100*v;e[h].height-=X,e[h].positionY-=m,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("T"===n){var g=r[o].positionY,f=r[o].height,p=g-t,v=p/f*100;w=g+f-e[h].positionY;var X=e[h].height/100*v,m=w/100*v;e[h].height+=X,e[h].positionY-=m,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("BR"===n){var g=r[o].positionY,f=r[o].height,p=t-(g+f),v=p/f*100;w=e[h].positionY-g;var X=e[h].height/100*v,m=w/100*v;e[h].height+=X,e[h].positionY+=m;var l=r[o].positionX,s=r[o].width,a=i-(l+s),c=a/s*100;effectivePX=e[h].positionX-l;var d=e[h].width/100*c,u=effectivePX/100*c;e[h].width+=d,e[h].positionX+=u,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("BL"===n){var g=r[o].positionY,f=r[o].height,p=g+f-t,v=p/f*100;w=e[h].positionY-g;var X=e[h].height/100*v,m=w/100*v;e[h].height-=X,e[h].positionY-=m;var l=r[o].positionX,s=r[o].width,a=l-i,c=a/s*100;effectivePX=l+s-e[h].positionX;var d=e[h].width/100*c,u=effectivePX/100*c;e[h].positionX-=u,e[h].width+=d,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("TL"===n){var g=r[o].positionY,f=r[o].height,p=g-t,v=p/f*100;w=g+f-e[h].positionY;var X=e[h].height/100*v,m=w/100*v;e[h].height+=X,e[h].positionY-=m;var l=r[o].positionX,s=r[o].width,a=l-i,c=a/s*100;effectivePX=l+s-e[h].positionX;var d=e[h].width/100*c,u=effectivePX/100*c;e[h].positionX-=u,e[h].width+=d,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}if("TR"===n){var g=r[o].positionY,f=r[o].height,p=g-t,v=p/f*100;w=g+f-e[h].positionY;var X=e[h].height/100*v,m=w/100*v;e[h].height+=X,e[h].positionY-=m;var l=r[o].positionX,s=r[o].width,a=l+s-i,c=a/s*100;effectivePX=e[h].positionX-l;var d=e[h].width/100*c,u=effectivePX/100*c;e[h].width-=d,e[h].positionX-=u,null!==e[h].childElements&&M(e[h].childElements,i,t,n,o)}}},x=function(){for(var e=0,i=o.length,t=0;t<r.length;t++)for(var n=0;i-e>n;n++)r[t].id===o[n].id&&(o.push(o[n]),o.splice(n,1),e++);I()},C=function(){for(var e=(o.length,0);e<r.length;e++)for(var i=0;i<o.length;i++)r[e].id===o[i].id&&(o.splice(0,0,o[i]),o.splice(i+1,1));I()},L=function(e){groupPresent=!1,event.preventDefault();var i=event.pageX,t=event.pageY;groupMenu.css({top:t+1,left:i+1}),r.length<2?ungroupMenu.css({top:t+1,left:i+1}):ungroupMenu.css({top:t+31,left:i+1});var n=groupMenu.width(),o=groupMenu.height(),h=$canvas.width,l=$canvas.height;i+n>h&&(ungroupMenu.css({left:i-n}),contextMenu.css({left:i-n})),t+o>l&&(ungroupMenu.css({top:t-o}),contextMenu.css({top:t-o}));for(var s=0;s<r.length;s++)null!==r[s].childElements&&(groupPresent=!0);r.length>1&&(groupMenu.show(),groupMenu.unbind().click(function(){B(),ungroupMenu.hide()})),groupPresent&&(ungroupMenu.show(),ungroupMenu.unbind().click(function(){T(e)}))},B=function(){var e=0,i={};dimensions={};var t=r.length;W(dimensions),i.id="GRP"+u,i.positionX=dimensions.X,i.positionY=dimensions.Y,i.width=dimensions.W,i.height=dimensions.H,i.childElements=[],i.parentElement=null,o.push(i),u++;for(var n=0;t>n;n++)r[n].parentElement=o[o.length-1],o[o.length-1].childElements[e]=r[n],e++;r=[o[o.length-1]],groupMenu.hide();var h=$selectionSurface.getContext("2d");h.clearRect(0,0,$selectionSurface.width,$selectionSurface.height),z()},T=function(){for(var e=0,i=$selectionSurface.getContext("2d"),t=0;t<r.length;t++)if(null!==r[t].childElements)for(var n=0;n<o.length;n++)if(o[n].id===r[t].id){for(var h=0;h<o[n].childElements.length;h++)o[n].childElements[h].parentElement=null;delete o[n],e++}o.sort(),o.splice(o.length-e,e),ungroupMenu.hide(),r.length=0,i.clearRect(0,0,$selectionSurface.width,$selectionSurface.height)},I=function(){var e=$canvas.getContext("2d"),i=o.length;e.clearRect(0,0,$canvas.width,$canvas.height);for(var t=0;i>t;t++)if(null===o[t].parentElement){var n=o[t];n.width<=5&&(n.width=5),n.height<=5&&(n.height=5),null!==n.childElements?_(n.childElements):e.drawImage(n.image[0],n.positionX,n.positionY,n.width,n.height)}},_=function(e){for(var i=$canvas.getContext("2d"),t=0;t<e.length;t++)null!==e[t].childElements?_(e[t].childElements):(e[t].width<=3&&(e[t].width=3),e[t].height<=3&&(e[t].height=3),i.drawImage(e[t].image[0],e[t].positionX,e[t].positionY,e[t].width,e[t].height))},W=function(e){_allPosX=[],_allPosY=[],_allPosW=[],_allPosH=[];for(var i=0;i<r.length;i++)_allPosX.push(r[i].positionX),_allPosY.push(r[i].positionY),_allPosW.push(r[i].positionX+r[i].width),_allPosH.push(r[i].positionY+r[i].height);return _allPosX.sort(function(e,i){return e-i}),_allPosY.sort(function(e,i){return e-i}),_allPosW.sort(function(e,i){return e-i}),_allPosH.sort(function(e,i){return e-i}),e.X=_allPosX[0]-10,e.Y=_allPosY[0]-10,e.W=_allPosW[_allPosW.length-1]-e.X+10,e.H=_allPosH[_allPosH.length-1]-e.Y+10,e},z=function(){for(var e=$selectionSurface.getContext("2d"),i=0;i<r.length;i++)if(null!==r[i].childElements)k(i);else if(r[i].width>=2&&r[i].height>=2){var t=r[i].positionX,n=r[i].positionY,o=r[i].width,h=r[i].height,l=r[i].positionX+r[i].width,s=r[i].positionY+r[i].height,a=t+(l-t)/2,c=n+(s-n)/2,d=border-5;e.beginPath(),e.lineWidth=borderWidth,e.strokeStyle=selectionColor,e.setLineDash([10,10]),e.fillStyle=selectionColor,e.strokeRect(t,n,o,h),e.fillRect(t-d/2,n-d/2,d,d),e.fillRect(l-d/2,n-d/2,d,d),e.fillRect(l-d/2,s-d/2,d,d),e.fillRect(t-d/2,s-d/2,d,d),e.fillRect(a-d/2,n-d/2,d,d),e.fillRect(a-d/2,s-d/2,d,d),e.fillRect(t-d/2,c-d/2,d,d),e.fillRect(l-d/2,c-d/2,d,d)}},k=function(e){var i=$selectionSurface.getContext("2d"),t=r[e];t.width>=2&&t.height>=2&&(i.beginPath(),i.lineWidth=borderWidth,i.strokeStyle=groupBoxColor,i.strokeRect(t.positionX,t.positionY,t.width,t.height),i.fillStyle=groupBoxColor,i.closePath(),i.beginPath(),i.arc(t.positionX,t.positionY,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX,t.positionY+t.height,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX+t.width,t.positionY,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX+t.width,t.positionY+t.height,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX,t.positionY+t.height/2,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX+t.width,t.positionY+t.height/2,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX+t.width/2,t.positionY,arcRadius,0,2*Math.PI),i.fill(),i.closePath(),i.beginPath(),i.arc(t.positionX+t.width/2,t.positionY+t.height,arcRadius,0,2*Math.PI),i.fill(),i.closePath())},G=function(e,i){var t=b(e,i);"TL"==t&&($dragSurface.style.cursor="nw-resize"),"TR"==t&&($dragSurface.style.cursor="ne-resize"),"BL"==t&&($dragSurface.style.cursor="sw-resize"),"BR"==t&&($dragSurface.style.cursor="se-resize"),"T"==t&&($dragSurface.style.cursor="n-resize"),"R"==t&&($dragSurface.style.cursor="e-resize"),"B"==t&&($dragSurface.style.cursor="s-resize"),"L"==t&&($dragSurface.style.cursor="w-resize"),"null"==t&&($dragSurface.style.cursor="move")},D=function(e,i){var t=e.getBoundingClientRect();return{x:i.clientX-t.left,y:i.clientY-t.top}},H=function(){if(showGrid)for(var e=$gridSurface.getContext("2d"),i=$gridSurface.width,t=$gridSurface.height,n=.5;i>n||t>n;n+=gridLineGap)e.moveTo(n,0),e.lineTo(n,t),e.moveTo(0,n),e.lineTo(i,n),e.lineWidth=1,e.strokeStyle=gridLineColor,e.stroke()};return{initialize:g,addImage:w,bringToFront:x,bringToBack:C}}();